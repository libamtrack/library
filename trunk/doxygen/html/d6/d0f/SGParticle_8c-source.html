<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8">
<title>libSGP: SGParticle.c Source File</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
<link href="../../tabs.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.5.6 -->
<script type="text/javascript">
<!--
function changeDisplayState (e){
  var num=this.id.replace(/[^[0-9]/g,'');
  var button=this.firstChild;
  var sectionDiv=document.getElementById('dynsection'+num);
  if (sectionDiv.style.display=='none'||sectionDiv.style.display==''){
    sectionDiv.style.display='block';
    button.src='../../open.gif';
  }else{
    sectionDiv.style.display='none';
    button.src='../../closed.gif';
  }
}
function initDynSections(){
  var divs=document.getElementsByTagName('div');
  var sectionCounter=1;
  for(var i=0;i<divs.length-1;i++){
    if(divs[i].className=='dynheader'&&divs[i+1].className=='dynsection'){
      var header=divs[i];
      var section=divs[i+1];
      var button=header.firstChild;
      if (button!='IMG'){
        divs[i].insertBefore(document.createTextNode(' '),divs[i].firstChild);
        button=document.createElement('img');
        divs[i].insertBefore(button,divs[i].firstChild);
      }
      header.style.cursor='pointer';
      header.onclick=changeDisplayState;
      header.id='dynheader'+sectionCounter;
      button.src='../../closed.gif';
      section.id='dynsection'+sectionCounter;
      section.style.display='none';
      section.style.marginLeft='14px';
      sectionCounter++;
    }
  }
}
window.onload = initDynSections;
-->
</script>
<div class="navigation" id="top">
  <div class="tabs">
    <ul>
      <li><a href="../../index.html"><span>Main&nbsp;Page</span></a></li>
      <li><a href="../../classes.html"><span>Data&nbsp;Structures</span></a></li>
      <li class="current"><a href="../../files.html"><span>Files</span></a></li>
    </ul>
  </div>
<h1>SGParticle.c</h1><a href="../../d4/d2a/SGParticle_8c.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="preprocessor">#include &lt;stdio.h&gt;</span>
<a name="l00002"></a>00002 <span class="preprocessor">#include &lt;stdlib.h&gt;</span>
<a name="l00003"></a>00003 <span class="preprocessor">#include &lt;time.h&gt;</span>
<a name="l00004"></a>00004 
<a name="l00005"></a><a class="code" href="../../d4/d2a/SGParticle_8c.html#1ccb4f7fa68c505ffc341ed04d583bc2">00005</a> <span class="preprocessor">#define _WINDOWS // [_LINUX or _WINDOWS] : in Linux we have isnan function while in Windows we have _isnan</span>
<a name="l00006"></a><a class="code" href="../../d4/d2a/SGParticle_8c.html#f92b94fcf362e093e6d3a11876db2a1a">00006</a> <span class="preprocessor"></span><span class="preprocessor">#define _S // [_S or _R] in S we can pass long type to the function via as.single, but in R we pass int type</span>
<a name="l00007"></a>00007 <span class="preprocessor"></span><span class="comment">//#define _DEBUG // debugging printouts</span>
<a name="l00008"></a><a class="code" href="../../d4/d2a/SGParticle_8c.html#95c20913f38781f18ffe9a44f1f3a8b9">00008</a> <span class="preprocessor">#define _SOLVER // use SOLVER instead of analytical inversion in r_RDD_m</span>
<a name="l00009"></a>00009 <span class="preprocessor"></span>
<a name="l00010"></a>00010 <span class="preprocessor">#include "<a class="code" href="../../d3/de7/SGP__Constants_8h.html">SGP_Constants.h</a>"</span>
<a name="l00011"></a>00011 <span class="preprocessor">#include "<a class="code" href="../../de/d4e/SGP__Data_8h.html">SGP_Data.h</a>"</span>
<a name="l00012"></a>00012 <span class="preprocessor">#include "<a class="code" href="../../d4/d28/SGP__Utils_8h.html">SGP_Utils.h</a>"</span>
<a name="l00013"></a>00013 <span class="preprocessor">#include "<a class="code" href="../../dc/d6f/SGP__Functions_8h.html">SGP_Functions.h</a>"</span>
<a name="l00014"></a>00014 <span class="preprocessor">#include "<a class="code" href="../../d6/dd0/SGP__RDD_8h.html">SGP_RDD.h</a>"</span>
<a name="l00015"></a>00015 <span class="preprocessor">#include "<a class="code" href="../../d1/ddc/SGP__SuccessiveConvolutions_8h.html">SGP_SuccessiveConvolutions.h</a>"</span>
<a name="l00016"></a>00016 <span class="preprocessor">#include "<a class="code" href="../../d3/d52/SGP__GammaResponse_8h.html">SGP_GammaResponse.h</a>"</span>
<a name="l00017"></a>00017 <span class="preprocessor">#include "<a class="code" href="../../de/d04/SGP__FileOperations_8h.html">SGP_FileOperations.h</a>"</span>
<a name="l00018"></a>00018 <span class="preprocessor">#include "<a class="code" href="../../d0/d72/SGP__ParabolicCylinderFunction_8h.html">SGP_ParabolicCylinderFunction.h</a>"</span>
<a name="l00019"></a>00019 <span class="preprocessor">#include "<a class="code" href="../../d9/dc4/SGP__Transport_8h.html">SGP_Transport.h</a>"</span>
<a name="l00020"></a>00020 
<a name="l00021"></a>00021 <span class="preprocessor">#include &lt;gsl/gsl_rng.h&gt;</span>
<a name="l00022"></a>00022 <span class="preprocessor">#include &lt;gsl/gsl_integration.h&gt;</span>
<a name="l00023"></a>00023 
<a name="l00024"></a><a class="code" href="../../d1/dd5/SGParticle_8h.html#5fc2b081664ab68200ae7dab2c24a500">00024</a> <span class="keywordtype">void</span> <a class="code" href="../../d4/d2a/SGParticle_8c.html#2d2dba701bdcdb2ac3165be4ce7550d0">SGP_efficiency</a>(    <span class="keywordtype">long</span>*   n,
<a name="l00025"></a>00025                                                 <span class="keywordtype">float</span>*  E_MeV_u,
<a name="l00026"></a>00026                                                 <span class="keywordtype">long</span>*   particle_no,
<a name="l00027"></a>00027                                                 <span class="keywordtype">float</span>*  fluence_cm2,
<a name="l00028"></a>00028                                                 <span class="keywordtype">long</span>*   <a class="code" href="../../d3/de7/SGP__Constants_8h.html#25222ab39d868c8c3763ddac1b75df11">material_no</a>,
<a name="l00029"></a>00029                                                 <span class="keywordtype">long</span>*   RDD_model,
<a name="l00030"></a>00030                                                 <span class="keywordtype">float</span>*  RDD_parameters,
<a name="l00031"></a>00031                                                 <span class="keywordtype">long</span>*   ER_model,
<a name="l00032"></a>00032                                                 <span class="keywordtype">float</span>*  ER_parameters,
<a name="l00033"></a>00033                                                 <span class="keywordtype">long</span>*   gamma_model,
<a name="l00034"></a>00034                                                 <span class="keywordtype">float</span>*  gamma_parameters,
<a name="l00035"></a>00035                                                 <span class="keywordtype">long</span>*   N2,
<a name="l00036"></a>00036                                                 <span class="keywordtype">float</span>*  fluence_factor,
<a name="l00037"></a>00037                                                 <span class="keywordtype">int</span>*    write_output,
<a name="l00038"></a>00038                                                 <span class="keywordtype">int</span>*    shrink_tails,
<a name="l00039"></a>00039                                                 <span class="keywordtype">float</span>*  shrink_tails_under,
<a name="l00040"></a>00040                                                 <span class="keywordtype">int</span>*    adjust_N2,
<a name="l00041"></a>00041                                                 <span class="keywordtype">float</span>*  results)
<a name="l00042"></a>00042 {
<a name="l00043"></a>00043 
<a name="l00044"></a>00044 <span class="preprocessor">#ifdef _DEBUG</span>
<a name="l00045"></a>00045 <span class="preprocessor"></span>        indnt_init();
<a name="l00046"></a>00046         fprintf(debf,<span class="stringliteral">"%sSGP_efficiency\n"</span>,isp);
<a name="l00047"></a>00047         fprintf(debf,<span class="stringliteral">"%swrite_output = %d\n"</span>,isp,*write_output);
<a name="l00048"></a>00048         fprintf(debf,<span class="stringliteral">"%sshrink_tails = %d\n"</span>,isp,*shrink_tails);
<a name="l00049"></a>00049         fprintf(debf,<span class="stringliteral">"%sadjust_N2 = %d\n"</span>,isp,*adjust_N2);
<a name="l00050"></a>00050                 <span class="comment">//              fprintf(debf,"%sf1 = %g\n",isp,(1.0f/ (M_PI * (*a0_m)*(*a0_m))));</span>
<a name="l00051"></a>00051                 <span class="comment">//              fprintf(debf,"%sf2 = %g\n",isp,SGP_RDD_Katz_point_Gy(t_m,alpha,r_max_m,Katz_point_coeff_Gy));</span>
<a name="l00052"></a>00052                 <span class="comment">//              fprintf(debf,"%sf3 = %g\n",isp,geometryFunctionPhi(r_m,a0_m,t_m));</span>
<a name="l00053"></a>00053 <span class="preprocessor">#endif</span>
<a name="l00054"></a>00054 <span class="preprocessor"></span>
<a name="l00055"></a>00055 
<a name="l00056"></a>00056 <span class="preprocessor">#ifdef _R</span>
<a name="l00057"></a>00057 <span class="preprocessor"></span>        <span class="keywordtype">bool</span> write_output_b = <span class="keyword">false</span>;
<a name="l00058"></a>00058         <span class="keywordflow">if</span>( *write_output == 1)
<a name="l00059"></a>00059                 write_output_b = <span class="keyword">true</span>;
<a name="l00060"></a>00060 
<a name="l00061"></a>00061         <span class="keywordtype">bool</span> shrink_tails_b = <span class="keyword">false</span>;
<a name="l00062"></a>00062         <span class="keywordflow">if</span>( *shrink_tails == 1)
<a name="l00063"></a>00063                 shrink_tails_b = <span class="keyword">true</span>;
<a name="l00064"></a>00064 
<a name="l00065"></a>00065         <span class="keywordtype">bool</span> adjust_N2_b = <span class="keyword">false</span>;
<a name="l00066"></a>00066         <span class="keywordflow">if</span>( *adjust_N2 == 1)
<a name="l00067"></a>00067                 adjust_N2_b = <span class="keyword">true</span>;
<a name="l00068"></a>00068 
<a name="l00069"></a>00069         <span class="keywordtype">int</span> n_int = (int)(*n);
<a name="l00070"></a>00070         *n = (long)n_int;
<a name="l00071"></a>00071 
<a name="l00072"></a>00072         <span class="keywordtype">int</span> N2_int = (int)(*N2);
<a name="l00073"></a>00073         *N2 = (long)N2_int;
<a name="l00074"></a>00074 
<a name="l00075"></a>00075         <span class="keywordtype">int</span> RDD_model_int = (int)(*RDD_model);
<a name="l00076"></a>00076         *RDD_model = (long)RDD_model_int;
<a name="l00077"></a>00077 
<a name="l00078"></a>00078         <span class="keywordtype">int</span> ER_model_int = (int)(*ER_model);
<a name="l00079"></a>00079         *ER_model = (long)ER_model_int;
<a name="l00080"></a>00080 
<a name="l00081"></a>00081         <span class="keywordtype">int</span> gamma_model_int = (int)(*gamma_model);
<a name="l00082"></a>00082         *gamma_model = (long)gamma_model_int;
<a name="l00083"></a>00083 
<a name="l00084"></a>00084         <span class="keywordtype">int</span> material_no_int     = (int)(*material_no);
<a name="l00085"></a>00085         *material_no = (long)material_no_int;
<a name="l00086"></a>00086 
<a name="l00087"></a>00087         <span class="keywordtype">int</span> particle_no_int = (int)(*particle_no);
<a name="l00088"></a>00088         *particle_no = (long)particle_no_int;
<a name="l00089"></a>00089 <span class="preprocessor">#endif</span>
<a name="l00090"></a>00090 <span class="preprocessor"></span>
<a name="l00091"></a>00091 <span class="preprocessor">#ifdef _DEBUG</span>
<a name="l00092"></a>00092 <span class="preprocessor"></span>        fprintf(debf,<span class="stringliteral">"%sSGP_efficiency 2\n"</span>,isp);
<a name="l00093"></a>00093         fprintf(debf,<span class="stringliteral">"%swrite_output = %d\n"</span>,isp,*write_output);
<a name="l00094"></a>00094         fprintf(debf,<span class="stringliteral">"%sshrink_tails = %d\n"</span>,isp,*shrink_tails);
<a name="l00095"></a>00095         fprintf(debf,<span class="stringliteral">"%sadjust_N2 = %d\n"</span>,isp,*adjust_N2);
<a name="l00096"></a>00096                 <span class="comment">//              fprintf(debf,"%sf1 = %g\n",isp,(1.0f/ (M_PI * (*a0_m)*(*a0_m))));</span>
<a name="l00097"></a>00097                 <span class="comment">//              fprintf(debf,"%sf2 = %g\n",isp,SGP_RDD_Katz_point_Gy(t_m,alpha,r_max_m,Katz_point_coeff_Gy));</span>
<a name="l00098"></a>00098                 <span class="comment">//              fprintf(debf,"%sf3 = %g\n",isp,geometryFunctionPhi(r_m,a0_m,t_m));</span>
<a name="l00099"></a>00099 <span class="preprocessor">#endif</span>
<a name="l00100"></a>00100 <span class="preprocessor"></span>
<a name="l00101"></a>00101 
<a name="l00102"></a>00102         <span class="keywordtype">long</span>    n_bins_f1;
<a name="l00103"></a>00103         <span class="keywordtype">float</span>*  f1_parameters                   =       (<span class="keywordtype">float</span>*)calloc(9 * (*n), <span class="keyword">sizeof</span>(float));
<a name="l00104"></a>00104 
<a name="l00105"></a>00105         <a class="code" href="../../d6/db7/SGP__SuccessiveConvolutions_8c.html#65362e6ff610c63a0704f1f9166c7156">SGP_SC_get_f1_array_size</a>(       n,
<a name="l00106"></a>00106                                                                 E_MeV_u,
<a name="l00107"></a>00107                                                                 particle_no,
<a name="l00108"></a>00108                                                                 material_no,
<a name="l00109"></a>00109                                                                 RDD_model,
<a name="l00110"></a>00110                                                                 RDD_parameters,
<a name="l00111"></a>00111                                                                 ER_model,
<a name="l00112"></a>00112                                                                 ER_parameters,
<a name="l00113"></a>00113                                                                 N2,
<a name="l00114"></a>00114                                                                 &amp;n_bins_f1,
<a name="l00115"></a>00115                                                                 f1_parameters);
<a name="l00116"></a>00116 
<a name="l00117"></a>00117         <span class="keywordtype">float</span>*  f_parameters                    =       (<span class="keywordtype">float</span>*)calloc(7, <span class="keyword">sizeof</span>(<span class="keywordtype">float</span>));
<a name="l00118"></a>00118 
<a name="l00119"></a>00119         <span class="keywordtype">float</span>*  norm_fluence                    =       (<span class="keywordtype">float</span>*)calloc(*n, <span class="keyword">sizeof</span>(<span class="keywordtype">float</span>));
<a name="l00120"></a>00120         <span class="keywordtype">float</span>*  dose_contribution_Gy    =       (<span class="keywordtype">float</span>*)calloc(*n, <span class="keyword">sizeof</span>(<span class="keywordtype">float</span>));
<a name="l00121"></a>00121 
<a name="l00122"></a>00122         <span class="keywordtype">float</span>*  f1_d_Gy                                 =       (<span class="keywordtype">float</span>*)calloc(n_bins_f1, <span class="keyword">sizeof</span>(<span class="keywordtype">float</span>));
<a name="l00123"></a>00123         <span class="keywordtype">float</span>*  f1_dd_Gy                                =       (<span class="keywordtype">float</span>*)calloc(n_bins_f1, <span class="keyword">sizeof</span>(<span class="keywordtype">float</span>));
<a name="l00124"></a>00124         <span class="keywordtype">float</span>*  f1                                              =       (<span class="keywordtype">float</span>*)calloc(n_bins_f1, <span class="keyword">sizeof</span>(<span class="keywordtype">float</span>));
<a name="l00125"></a>00125 
<a name="l00126"></a>00126         <a class="code" href="../../d6/db7/SGP__SuccessiveConvolutions_8c.html#ae760e3c9a227f2b771777f84fff86d3">SGP_SC_get_f1</a>(  n,
<a name="l00127"></a>00127                                         E_MeV_u,
<a name="l00128"></a>00128                                         particle_no,
<a name="l00129"></a>00129                                         fluence_cm2,
<a name="l00130"></a>00130                                         <span class="comment">/* detector parameters */</span>
<a name="l00131"></a>00131                                         material_no,
<a name="l00132"></a>00132                                         RDD_model,
<a name="l00133"></a>00133                                         RDD_parameters,
<a name="l00134"></a>00134                                         <span class="comment">/* electron range model */</span>
<a name="l00135"></a>00135                                         ER_model,
<a name="l00136"></a>00136                                         ER_parameters,
<a name="l00137"></a>00137                                         <span class="comment">/* algorith parameters*/</span>
<a name="l00138"></a>00138                                         N2,
<a name="l00139"></a>00139                                         &amp;n_bins_f1,
<a name="l00140"></a>00140                                         <span class="comment">/* f1 parameters*/</span>
<a name="l00141"></a>00141                                         f1_parameters,
<a name="l00142"></a>00142                                         <span class="comment">// from here: return values</span>
<a name="l00143"></a>00143                                         norm_fluence,
<a name="l00144"></a>00144                                         dose_contribution_Gy,
<a name="l00145"></a>00145                                         f_parameters,
<a name="l00146"></a>00146                                         f1_d_Gy,
<a name="l00147"></a>00147                                         f1_dd_Gy,
<a name="l00148"></a>00148                                         f1);
<a name="l00149"></a>00149 
<a name="l00150"></a>00150         <span class="keywordtype">long</span>                    n_bins_f;
<a name="l00151"></a>00151         <span class="keywordtype">float</span>                   u_start;
<a name="l00152"></a>00152         <span class="keywordtype">long</span>                    n_convolutions;
<a name="l00153"></a>00153 
<a name="l00154"></a>00154 
<a name="l00155"></a>00155         <a class="code" href="../../d6/db7/SGP__SuccessiveConvolutions_8c.html#e8e48ab52038822ee6cf825db1ef3641">SGP_SC_get_f_array_size</a>(        &amp;f_parameters[0],                       <span class="comment">// = u</span>
<a name="l00156"></a>00156                         fluence_factor,
<a name="l00157"></a>00157                         N2,
<a name="l00158"></a>00158                         &amp;n_bins_f1,
<a name="l00159"></a>00159                         f1_d_Gy,
<a name="l00160"></a>00160                         f1_dd_Gy,
<a name="l00161"></a>00161                         f1,
<a name="l00162"></a>00162                         <span class="comment">// from here: return values</span>
<a name="l00163"></a>00163                         &amp;n_bins_f,
<a name="l00164"></a>00164                         &amp;u_start,
<a name="l00165"></a>00165                         &amp;n_convolutions);
<a name="l00166"></a>00166 
<a name="l00167"></a>00167         <span class="keywordtype">float</span>*  f_d_Gy                                  =       (<span class="keywordtype">float</span>*)calloc(n_bins_f, <span class="keyword">sizeof</span>(<span class="keywordtype">float</span>));
<a name="l00168"></a>00168         <span class="keywordtype">float</span>*  f_dd_Gy                                 =       (<span class="keywordtype">float</span>*)calloc(n_bins_f, <span class="keyword">sizeof</span>(<span class="keywordtype">float</span>));
<a name="l00169"></a>00169         <span class="keywordtype">float</span>*  f                                               =       (<span class="keywordtype">float</span>*)calloc(n_bins_f, <span class="keyword">sizeof</span>(<span class="keywordtype">float</span>));
<a name="l00170"></a>00170         <span class="keywordtype">float</span>*  fdd                                             =       (<span class="keywordtype">float</span>*)calloc(n_bins_f, <span class="keyword">sizeof</span>(<span class="keywordtype">float</span>));
<a name="l00171"></a>00171         <span class="keywordtype">float</span>*  dfdd                                    =       (<span class="keywordtype">float</span>*)calloc(n_bins_f, <span class="keyword">sizeof</span>(<span class="keywordtype">float</span>));
<a name="l00172"></a>00172         <span class="keywordtype">float</span>   f0                                              =       0.0f;
<a name="l00173"></a>00173         <span class="keywordtype">float</span>   d_check                                 =       0.0f;
<a name="l00174"></a>00174 
<a name="l00175"></a>00175         <a class="code" href="../../d6/db7/SGP__SuccessiveConvolutions_8c.html#e7a1cf54b04bd06a64ab4627c2995cfe">SGP_SC_get_f_start</a>(     &amp;u_start,
<a name="l00176"></a>00176                         &amp;n_bins_f1,
<a name="l00177"></a>00177                         N2,
<a name="l00178"></a>00178                         f1_d_Gy,
<a name="l00179"></a>00179                         f1_dd_Gy,
<a name="l00180"></a>00180                         f1,
<a name="l00181"></a>00181                         &amp;n_bins_f,
<a name="l00182"></a>00182                         <span class="comment">// from here: return values</span>
<a name="l00183"></a>00183                         f_d_Gy,
<a name="l00184"></a>00184                         f_dd_Gy,
<a name="l00185"></a>00185                         f);
<a name="l00186"></a>00186 
<a name="l00187"></a>00187         <a class="code" href="../../d6/db7/SGP__SuccessiveConvolutions_8c.html#e89669b31a52fbe0e043001d4f655c6d">SGP_SuccessiveConvolutions</a>(     &amp;f_parameters[0],               <span class="comment">// u</span>
<a name="l00188"></a>00188                         &amp;n_bins_f,
<a name="l00189"></a>00189                         N2,
<a name="l00190"></a>00190                         <span class="comment">// input + return values</span>
<a name="l00191"></a>00191                         &amp;n_bins_f1,
<a name="l00192"></a>00192                         f_d_Gy,
<a name="l00193"></a>00193                         f_dd_Gy,
<a name="l00194"></a>00194                         f,
<a name="l00195"></a>00195                         <span class="comment">// return values</span>
<a name="l00196"></a>00196                         &amp;f0,
<a name="l00197"></a>00197                         fdd,
<a name="l00198"></a>00198                         dfdd,
<a name="l00199"></a>00199                         &amp;d_check,
<a name="l00200"></a>00200                         write_output,
<a name="l00201"></a>00201                         shrink_tails,
<a name="l00202"></a>00202                         shrink_tails_under,
<a name="l00203"></a>00203                         adjust_N2);
<a name="l00204"></a>00204 
<a name="l00205"></a>00205         <span class="keywordtype">long</span>                    n_bins_f_used   = n_bins_f1;
<a name="l00206"></a>00206 
<a name="l00207"></a>00207         <span class="keywordtype">float</span>*  S                                               =       (<span class="keywordtype">float</span>*)calloc(n_bins_f_used, <span class="keyword">sizeof</span>(<span class="keywordtype">float</span>));
<a name="l00208"></a>00208         <span class="keywordtype">float</span>   S_HCP, S_gamma, efficiency;
<a name="l00209"></a>00209 
<a name="l00210"></a>00210         <a class="code" href="../../d8/d28/SGP__GammaResponse_8c.html#bb88563a058f7f62832f7eddc0ca4265">SGP_get_gamma_response</a>( &amp;n_bins_f_used,
<a name="l00211"></a>00211                                                         f_d_Gy,
<a name="l00212"></a>00212                                                         f_dd_Gy,
<a name="l00213"></a>00213                                                         f,
<a name="l00214"></a>00214                                                         &amp;f0,
<a name="l00215"></a>00215                                                         gamma_model,
<a name="l00216"></a>00216                                                         gamma_parameters,
<a name="l00217"></a>00217                                                         <span class="comment">// return</span>
<a name="l00218"></a>00218                                                         S,
<a name="l00219"></a>00219                                                         &amp;S_HCP,
<a name="l00220"></a>00220                                                         &amp;S_gamma,
<a name="l00221"></a>00221                                                         &amp;efficiency);
<a name="l00222"></a>00222 
<a name="l00223"></a>00223         results[0]                      =       efficiency;                             <span class="comment">// 0 - 4: algo independent results</span>
<a name="l00224"></a>00224         results[1]                      =       d_check;
<a name="l00225"></a>00225         results[2]                      =       S_HCP;
<a name="l00226"></a>00226         results[3]                      =       S_gamma;
<a name="l00227"></a>00227         results[5]                      =       f_parameters[0];                <span class="comment">// 5 - 9: algo specific: u</span>
<a name="l00228"></a>00228         results[6]                      =       u_start;
<a name="l00229"></a>00229         results[7]                      =       n_convolutions;
<a name="l00230"></a>00230 
<a name="l00231"></a>00231         free(f1_parameters);
<a name="l00232"></a>00232         free(f_parameters);
<a name="l00233"></a>00233         free(norm_fluence);
<a name="l00234"></a>00234         free(dose_contribution_Gy);
<a name="l00235"></a>00235         free(f1_d_Gy);
<a name="l00236"></a>00236         free(f1_dd_Gy);
<a name="l00237"></a>00237         free(f1);
<a name="l00238"></a>00238         free(f_d_Gy);
<a name="l00239"></a>00239         free(f_dd_Gy);
<a name="l00240"></a>00240         free(f);
<a name="l00241"></a>00241         free(fdd);
<a name="l00242"></a>00242         free(dfdd);
<a name="l00243"></a>00243         free(S);
<a name="l00244"></a>00244 }
<a name="l00245"></a>00245 
<a name="l00246"></a><a class="code" href="../../d1/dd5/SGParticle_8h.html#c5a105efc06356e8753bd5dffa15d013">00246</a> <span class="keywordtype">void</span> <a class="code" href="../../d4/d2a/SGParticle_8c.html#c5a105efc06356e8753bd5dffa15d013">SGP_efficiency_grid</a>(       <span class="keywordtype">long</span>*   n,
<a name="l00247"></a>00247                                                         <span class="keywordtype">float</span>*  E_MeV_u,
<a name="l00248"></a>00248                                                         <span class="keywordtype">long</span>*   particle_no,
<a name="l00249"></a>00249                                                         <span class="keywordtype">float</span>*  fluence_cm2,
<a name="l00250"></a>00250                                                         <span class="keywordtype">long</span>*   <a class="code" href="../../d3/de7/SGP__Constants_8h.html#25222ab39d868c8c3763ddac1b75df11">material_no</a>,
<a name="l00251"></a>00251                                                         <span class="keywordtype">long</span>*   RDD_model,
<a name="l00252"></a>00252                                                         <span class="keywordtype">float</span>*  RDD_parameters,
<a name="l00253"></a>00253                                                         <span class="keywordtype">long</span>*   ER_model,
<a name="l00254"></a>00254                                                         <span class="keywordtype">float</span>*  ER_parameters,
<a name="l00255"></a>00255                                                         <span class="keywordtype">long</span>*   gamma_model,
<a name="l00256"></a>00256                                                         <span class="keywordtype">float</span>*  gamma_parameters,
<a name="l00257"></a>00257         <span class="comment">//                                              method                                  = "grid",</span>
<a name="l00258"></a>00258                                                         <span class="keywordtype">long</span>*   N_runs,
<a name="l00259"></a>00259                                                         <span class="keywordtype">float</span>*  fluence_factor,
<a name="l00260"></a>00260                                                         <span class="keywordtype">bool</span>*   write_output,
<a name="l00261"></a>00261                                                         <span class="keywordtype">long</span>*   nX,
<a name="l00262"></a>00262                                                         <span class="keywordtype">float</span>*  grid_size_m,
<a name="l00263"></a>00263                                                         <span class="keywordtype">float</span>*  results)
<a name="l00264"></a>00264 {
<a name="l00265"></a>00265         FILE*           output_file;
<a name="l00266"></a>00266         <span class="keyword">struct </span>tm       *start_tm, *end_tm;
<a name="l00267"></a>00267         time_t          start_t, end_t;
<a name="l00268"></a>00268         start_t         = time(NULL);
<a name="l00269"></a>00269 
<a name="l00270"></a>00270         <span class="keywordtype">long</span>            i, j, k, m;
<a name="l00271"></a>00271         <span class="keywordtype">long</span>            n_grid                                  = (*nX) * (*nX);
<a name="l00272"></a>00272         <span class="keywordtype">float</span>           calc_grid_size_m                = (*grid_size_m) * (*nX);
<a name="l00273"></a>00273         <span class="keywordtype">float</span>           calc_grid_area_cm2              = calc_grid_size_m * calc_grid_size_m * 10000;
<a name="l00274"></a>00274 
<a name="l00275"></a>00275         output_file             =       fopen(<span class="stringliteral">"GridSummation.log"</span>,<span class="stringliteral">"w"</span>);
<a name="l00276"></a>00276         <span class="keywordflow">if</span> (output_file == NULL) <span class="keywordflow">return</span>;                                                                                        <span class="comment">// File error</span>
<a name="l00277"></a>00277 
<a name="l00278"></a>00278         fprintf(output_file, <span class="stringliteral">"##############################################################\n"</span>);
<a name="l00279"></a>00279         fprintf(output_file, <span class="stringliteral">"##############################################################\n"</span>);
<a name="l00280"></a>00280         fprintf(output_file, <span class="stringliteral">"This is SGP efficiency grid, version(2009/06/30).\n"</span>);
<a name="l00281"></a>00281         fprintf(output_file, <span class="stringliteral">"##############################################################\n"</span>);
<a name="l00282"></a>00282         fprintf(output_file, <span class="stringliteral">"\n\n\n"</span>);
<a name="l00283"></a>00283         start_tm                = localtime(&amp;start_t);
<a name="l00284"></a>00284         fprintf(output_file, <span class="stringliteral">"Start time and date: %s\n"</span>, asctime(start_tm));
<a name="l00285"></a>00285         fprintf(output_file, <span class="stringliteral">"calc grid:                        %d*%d = %d pixels\n"</span>, *nX, *nX, n_grid);
<a name="l00286"></a>00286         fprintf(output_file, <span class="stringliteral">"calc grid size/m:         %e\n"</span>, calc_grid_size_m);
<a name="l00287"></a>00287         fprintf(output_file, <span class="stringliteral">"calc grid area/cm2:       %e\n"</span>, calc_grid_area_cm2);
<a name="l00288"></a>00288 
<a name="l00289"></a>00289         <span class="comment">// Alloc checkerboard arrays</span>
<a name="l00290"></a>00290         <span class="keywordtype">float</span>*          grid_d_Gy               = (<span class="keywordtype">float</span>*)calloc(n_grid, <span class="keyword">sizeof</span>(<span class="keywordtype">float</span>));
<a name="l00291"></a>00291         <span class="keywordtype">float</span>*          grid_S                  = (<span class="keywordtype">float</span>*)calloc(n_grid, <span class="keyword">sizeof</span>(<span class="keywordtype">float</span>));
<a name="l00292"></a>00292 
<a name="l00293"></a>00293         <span class="comment">// Clear results</span>
<a name="l00294"></a>00294         <span class="keywordflow">for</span> (i = 0; i &lt; 10; i++){
<a name="l00295"></a>00295                 results[i]              = 0.0;
<a name="l00296"></a>00296         }
<a name="l00297"></a>00297 
<a name="l00298"></a>00298         <span class="comment">// Get f1, f parameters</span>
<a name="l00299"></a>00299         <span class="keywordtype">float</span>*          f1_parameters           = (<span class="keywordtype">float</span>*)calloc(*n * 9, <span class="keyword">sizeof</span>(<span class="keywordtype">float</span>));
<a name="l00300"></a>00300         <span class="keywordtype">float</span>*          f_parameters            = (<span class="keywordtype">float</span>*)calloc(7, <span class="keyword">sizeof</span>(<span class="keywordtype">float</span>));
<a name="l00301"></a>00301         <span class="keywordtype">float</span>*          norm_fluence            = (<span class="keywordtype">float</span>*)calloc(*n, <span class="keyword">sizeof</span>(<span class="keywordtype">float</span>));
<a name="l00302"></a>00302         <span class="keywordtype">float</span>*          dose_contribution_Gy= (<span class="keywordtype">float</span>*)calloc(*n, <span class="keyword">sizeof</span>(<span class="keywordtype">float</span>));
<a name="l00303"></a>00303         <span class="keywordtype">float</span>           max_r_max_m                     = 0.0f;
<a name="l00304"></a>00304 
<a name="l00305"></a>00305         fprintf(output_file, <span class="stringliteral">"f1 parameters for %d particles\n"</span>, *n);
<a name="l00306"></a>00306         <span class="keywordflow">for</span> (i = 0; i &lt; *n; i++){
<a name="l00307"></a>00307                 <a class="code" href="../../d9/d16/SGP__RDD_8c.html#787e26beb8146d2ad8c58a7c4b2656aa">SGP_RDD_f1_parameters</a>(  &amp;E_MeV_u[i],
<a name="l00308"></a>00308                                                                 &amp;particle_no[i],
<a name="l00309"></a>00309                                                                 material_no,
<a name="l00310"></a>00310                                                                 RDD_model,
<a name="l00311"></a>00311                                                                 RDD_parameters,
<a name="l00312"></a>00312                                                                 ER_model,
<a name="l00313"></a>00313                                                                 ER_parameters,
<a name="l00314"></a>00314                                                                 &amp;f1_parameters[i*9]);
<a name="l00315"></a>00315                 fprintf(output_file, <span class="stringliteral">"%e\t%e\t%e\t%e\t%e\t%e\t%e\t%e\t%e\n"</span>,    f1_parameters[i*9 + 0],
<a name="l00316"></a>00316                                                                                                                                                 f1_parameters[i*9 + 1],
<a name="l00317"></a>00317                                                                                                                                                 f1_parameters[i*9 + 2],
<a name="l00318"></a>00318                                                                                                                                                 f1_parameters[i*9 + 3],
<a name="l00319"></a>00319                                                                                                                                                 f1_parameters[i*9 + 4],
<a name="l00320"></a>00320                                                                                                                                                 f1_parameters[i*9 + 5],
<a name="l00321"></a>00321                                                                                                                                                 f1_parameters[i*9 + 6],
<a name="l00322"></a>00322                                                                                                                                                 f1_parameters[i*9 + 7],
<a name="l00323"></a>00323                                                                                                                                                 f1_parameters[i*9 + 8]);
<a name="l00324"></a>00324                 max_r_max_m                             =       <a class="code" href="../../d4/d28/SGP__Utils_8h.html#985ff4ce447bced94342e89ab3766fdd">FMAX</a>(max_r_max_m, f1_parameters[i*9 + 2]);
<a name="l00325"></a>00325         }
<a name="l00326"></a>00326 
<a name="l00327"></a>00327         fprintf(output_file, <span class="stringliteral">"\nOverall r.max/m = %e\n\n"</span>,      max_r_max_m);
<a name="l00328"></a>00328 
<a name="l00329"></a>00329         <span class="keywordtype">long</span>            n_bins_f1                       = 0;
<a name="l00330"></a>00330         <span class="keywordtype">long</span>            N2                                      = 0;
<a name="l00331"></a>00331         <a class="code" href="../../d6/db7/SGP__SuccessiveConvolutions_8c.html#ae760e3c9a227f2b771777f84fff86d3">SGP_SC_get_f1</a>(  n,                                              <span class="comment">// for f parameters only</span>
<a name="l00332"></a>00332                                         E_MeV_u,
<a name="l00333"></a>00333                                         particle_no,
<a name="l00334"></a>00334                                         fluence_cm2,
<a name="l00335"></a>00335                                         material_no,
<a name="l00336"></a>00336                                         RDD_model,
<a name="l00337"></a>00337                                         RDD_parameters,
<a name="l00338"></a>00338                                         ER_model,
<a name="l00339"></a>00339                                         ER_parameters,
<a name="l00340"></a>00340                                         &amp;N2,
<a name="l00341"></a>00341                                         &amp;n_bins_f1,
<a name="l00342"></a>00342                                         f1_parameters,
<a name="l00343"></a>00343                                         norm_fluence,
<a name="l00344"></a>00344                                         dose_contribution_Gy,
<a name="l00345"></a>00345                                         f_parameters,
<a name="l00346"></a>00346                                         NULL,
<a name="l00347"></a>00347                                         NULL,
<a name="l00348"></a>00348                                         NULL);
<a name="l00349"></a>00349 
<a name="l00350"></a>00350         fprintf(output_file, <span class="stringliteral">"f parameters\n"</span>);
<a name="l00351"></a>00351         fprintf(output_file, <span class="stringliteral">"%e\t%e\t%e\t%e\t%e\t%e\t%e\n"</span>,    f_parameters[0],
<a name="l00352"></a>00352                                                                                                                         f_parameters[1],
<a name="l00353"></a>00353                                                                                                                         f_parameters[2],
<a name="l00354"></a>00354                                                                                                                         f_parameters[3],
<a name="l00355"></a>00355                                                                                                                         f_parameters[4],
<a name="l00356"></a>00356                                                                                                                         f_parameters[5],
<a name="l00357"></a>00357                                                                                                                         f_parameters[6]);
<a name="l00358"></a>00358 
<a name="l00359"></a>00359         <span class="comment">// Largest r.max --&gt; calculate size of sample area</span>
<a name="l00360"></a>00360         <span class="keywordtype">float</span> sample_grid_size_m        = calc_grid_size_m + 2.01f * max_r_max_m;
<a name="l00361"></a>00361         <span class="keywordtype">float</span> sample_grid_area_cm2      = sample_grid_size_m * sample_grid_size_m * 10000;
<a name="l00362"></a>00362         fprintf(output_file, <span class="stringliteral">"sample grid size/m   = %e\n"</span>, sample_grid_size_m);
<a name="l00363"></a>00363         fprintf(output_file, <span class="stringliteral">"sample grid area/cm2 = %e\n"</span>, sample_grid_area_cm2);
<a name="l00364"></a>00364 
<a name="l00365"></a>00365         <span class="comment">// mean and actual number of particles on sample_area</span>
<a name="l00366"></a>00366         <span class="keywordtype">float</span>*  mean_number_particles   = (<span class="keywordtype">float</span>*)calloc(*n, <span class="keyword">sizeof</span>(<span class="keywordtype">float</span>));
<a name="l00367"></a>00367         <span class="keywordtype">long</span>*   act_number_particles    = (<span class="keywordtype">long</span>*)calloc(*n, <span class="keyword">sizeof</span>(<span class="keywordtype">float</span>));
<a name="l00368"></a>00368         <span class="keywordflow">for</span> (i = 0; i &lt; *n; i++){
<a name="l00369"></a>00369                 mean_number_particles[i]        = sample_grid_area_cm2 * f_parameters[1] * norm_fluence[i];                             <span class="comment">// Area * Total_fluence (particle i)</span>
<a name="l00370"></a>00370         }
<a name="l00371"></a>00371 
<a name="l00372"></a>00372         <span class="comment">// create and initialise RNGs</span>
<a name="l00373"></a>00373         gsl_rng * rng1  = gsl_rng_alloc (gsl_rng_taus);
<a name="l00374"></a>00374         gsl_rng * rng2  = gsl_rng_alloc (gsl_rng_taus);
<a name="l00375"></a>00375         gsl_rng_set(rng1, 12345678);
<a name="l00376"></a>00376         gsl_rng_set(rng2, 2345678);
<a name="l00377"></a>00377 
<a name="l00378"></a>00378 
<a name="l00379"></a>00379         <span class="comment">// run loop</span>
<a name="l00380"></a>00380         <span class="keywordtype">long</span>    n_particles;
<a name="l00381"></a>00381         <span class="keywordflow">for</span> (m = 0; m &lt; *N_runs; m++){
<a name="l00382"></a>00382                 <span class="keywordtype">float</span>*  run_results                     = (<span class="keywordtype">float</span>*)calloc(10, <span class="keyword">sizeof</span>(<span class="keywordtype">float</span>));
<a name="l00383"></a>00383 
<a name="l00384"></a>00384                 <span class="comment">// sample particles numbers</span>
<a name="l00385"></a>00385                 n_particles     = 0;
<a name="l00386"></a>00386                 <span class="keywordflow">for</span> (i = 0; i &lt; *n; i++){
<a name="l00387"></a>00387                         act_number_particles[i] =       (long)gsl_ran_poisson(rng1, mean_number_particles[i]);
<a name="l00388"></a>00388                         n_particles                             +=      act_number_particles[i];
<a name="l00389"></a>00389                 }
<a name="l00390"></a>00390 
<a name="l00391"></a>00391                 <span class="keywordflow">if</span>(*N_runs &lt;= 20){
<a name="l00392"></a>00392                         fprintf(output_file, <span class="stringliteral">"\n\nRun %d:\n"</span>, m + 1);
<a name="l00393"></a>00393                         fprintf(output_file, <span class="stringliteral">"Actual number of particles (mean)\n"</span>);
<a name="l00394"></a>00394                         <span class="keywordflow">for</span> (i = 0; i &lt; *n; i++){
<a name="l00395"></a>00395                                 fprintf(output_file, <span class="stringliteral">"particle %d: %d (%e)\n"</span>, i, act_number_particles[i], mean_number_particles[i]);
<a name="l00396"></a>00396                         }
<a name="l00397"></a>00397                         fprintf(output_file, <span class="stringliteral">"\nIn total: %d\n"</span>, n_particles);
<a name="l00398"></a>00398                 }
<a name="l00399"></a>00399 
<a name="l00400"></a>00400                 <span class="comment">// alloc particle array</span>
<a name="l00401"></a>00401                 <span class="keywordtype">float</span>*  x_pos                           = (<span class="keywordtype">float</span>*)calloc(n_particles, <span class="keyword">sizeof</span>(<span class="keywordtype">float</span>));
<a name="l00402"></a>00402                 <span class="keywordtype">float</span>*  y_pos                           = (<span class="keywordtype">float</span>*)calloc(n_particles, <span class="keyword">sizeof</span>(<span class="keywordtype">float</span>));
<a name="l00403"></a>00403                 <span class="keywordtype">long</span>*   particle_index          = (<span class="keywordtype">long</span>*)calloc(n_particles, <span class="keyword">sizeof</span>(<span class="keywordtype">long</span>));
<a name="l00404"></a>00404                 <span class="keywordtype">float</span>*  r_m                                     = (<span class="keywordtype">float</span>*)calloc(n_particles, <span class="keyword">sizeof</span>(<span class="keywordtype">float</span>));
<a name="l00405"></a>00405                 <span class="keywordtype">float</span>*  r_max_m                         = (<span class="keywordtype">float</span>*)calloc(n_particles, <span class="keyword">sizeof</span>(<span class="keywordtype">float</span>));
<a name="l00406"></a>00406                 <span class="keywordtype">long</span>    n_tmp                           = 1;
<a name="l00407"></a>00407                 <span class="keywordtype">float</span>   d_tmp_Gy                        = 0.0;
<a name="l00408"></a>00408 
<a name="l00409"></a>00409                 <span class="comment">// fill in index / r_max_m</span>
<a name="l00410"></a>00410                 j               = 0;
<a name="l00411"></a>00411                 k               = 0;
<a name="l00412"></a>00412                 <span class="keywordflow">for</span> (i = 0; i &lt; n_particles; i++){
<a name="l00413"></a>00413                         <span class="keywordflow">if</span>(k &gt;= act_number_particles[j]){
<a name="l00414"></a>00414                                 k               = 0;
<a name="l00415"></a>00415                                 j++;
<a name="l00416"></a>00416                         }
<a name="l00417"></a>00417                         k++;
<a name="l00418"></a>00418                         particle_index[i]       =       j;
<a name="l00419"></a>00419                         r_max_m[i]                      =       f1_parameters[j*9 + 2];
<a name="l00420"></a>00420                 }
<a name="l00421"></a>00421 
<a name="l00422"></a>00422 <span class="comment">//              fprintf(output_file, "particle.no; particle.index; r.max.m\n");</span>
<a name="l00423"></a>00423 <span class="comment">//              for (i=0; i &lt; n_particles; i++){</span>
<a name="l00424"></a>00424 <span class="comment">//                      fprintf(output_file, "%d; %d; %e\n", i, particle_index[i], r_max_m[i]);</span>
<a name="l00425"></a>00425 <span class="comment">//              }</span>
<a name="l00426"></a>00426 
<a name="l00427"></a>00427                 <span class="comment">// sample particle positions</span>
<a name="l00428"></a>00428                 <span class="keywordflow">for</span> (i = 0; i &lt; n_particles; i++){
<a name="l00429"></a>00429                         x_pos[i]                                        = (float)gsl_rng_uniform_pos(rng2) * sample_grid_size_m;
<a name="l00430"></a>00430                         y_pos[i]                                        = (float)gsl_rng_uniform_pos(rng2) * sample_grid_size_m;
<a name="l00431"></a>00431                 }
<a name="l00432"></a>00432 
<a name="l00433"></a>00433                 <span class="comment">// grid loop</span>
<a name="l00434"></a>00434                 <span class="keywordflow">for</span> (j = 0; j &lt; *nX; j++){                                      <span class="comment">// y</span>
<a name="l00435"></a>00435                         <span class="keywordtype">float</span> cur_y_pos                 =       max_r_max_m + ((float)j + 0.5f)*(*grid_size_m);
<a name="l00436"></a>00436                         <span class="keywordflow">for</span> (i = 0; i &lt; *nX; i++){                              <span class="comment">// x</span>
<a name="l00437"></a>00437                                 <span class="keywordtype">float</span> cur_x_pos                 =       max_r_max_m + ((float)i + 0.5f)*(*grid_size_m);
<a name="l00438"></a>00438                                 grid_d_Gy[j * (*nX) + i]=       0.0f;
<a name="l00439"></a>00439                                 <span class="keywordflow">for</span> (k = 0; k &lt; n_particles; k++){      <span class="comment">// particles</span>
<a name="l00440"></a>00440                                         r_m[k]                                  =       sqrt( (x_pos[k] - cur_x_pos) * (x_pos[k] - cur_x_pos) +
<a name="l00441"></a>00441                                                                                                           (y_pos[k] - cur_y_pos) * (y_pos[k] - cur_y_pos));
<a name="l00442"></a>00442                                         <span class="keywordflow">if</span>(r_m[k] &lt;= r_max_m[k]){               <span class="comment">// does particle contribute?</span>
<a name="l00443"></a>00443                                                 <a class="code" href="../../d9/d16/SGP__RDD_8c.html#3f17b5dd45a2a8161953aad2fecb4f02">SGP_D_RDD_Gy</a>(   &amp;n_tmp,
<a name="l00444"></a>00444                                                                                 &amp;r_m[k],
<a name="l00445"></a>00445                                                                                 &amp;E_MeV_u[particle_index[k]],
<a name="l00446"></a>00446                                                                                 &amp;particle_no[particle_index[k]],
<a name="l00447"></a>00447                                                                                 material_no,
<a name="l00448"></a>00448                                                                                 RDD_model,
<a name="l00449"></a>00449                                                                                 RDD_parameters,
<a name="l00450"></a>00450                                                                                 ER_model,
<a name="l00451"></a>00451                                                                                 ER_parameters,
<a name="l00452"></a>00452                                                                                 &amp;d_tmp_Gy);
<a name="l00453"></a>00453                                                 grid_d_Gy[j * (*nX) + i]        +=      d_tmp_Gy;
<a name="l00454"></a>00454                                         } <span class="comment">// particle contribution</span>
<a name="l00455"></a>00455                                 }<span class="comment">// particle loop</span>
<a name="l00456"></a>00456                         } <span class="comment">// x loop</span>
<a name="l00457"></a>00457                 } <span class="comment">// y loop</span>
<a name="l00458"></a>00458 
<a name="l00459"></a>00459                 <span class="comment">// get gamma response for local dose</span>
<a name="l00460"></a>00460                 <a class="code" href="../../d8/d28/SGP__GammaResponse_8c.html#271890a453885d3a865885e249dc2fc3">SGP_gamma_response</a>(     &amp;n_grid,
<a name="l00461"></a>00461                                                         grid_d_Gy,
<a name="l00462"></a>00462                                                         gamma_model,
<a name="l00463"></a>00463                                                         gamma_parameters,
<a name="l00464"></a>00464                                                         grid_S);
<a name="l00465"></a>00465                 <span class="comment">// averaging</span>
<a name="l00466"></a>00466                 <span class="keywordtype">float</span> d_total_Gy        = 0.0f;
<a name="l00467"></a>00467                 <span class="keywordtype">float</span> S_HCP                     = 0.0f;
<a name="l00468"></a>00468                 <span class="keywordflow">for</span> (i = 0; i &lt; n_grid; i++){
<a name="l00469"></a>00469                         d_total_Gy              +=      grid_d_Gy[i];
<a name="l00470"></a>00470                         S_HCP                   +=      grid_S[i];
<a name="l00471"></a>00471                 }
<a name="l00472"></a>00472 
<a name="l00473"></a>00473                 S_HCP                           /=      n_grid;
<a name="l00474"></a>00474                 d_total_Gy                      /= n_grid;
<a name="l00475"></a>00475 
<a name="l00476"></a>00476                 <span class="keywordtype">float</span> S_gamma   = 0.0f;
<a name="l00477"></a>00477                 <a class="code" href="../../d8/d28/SGP__GammaResponse_8c.html#271890a453885d3a865885e249dc2fc3">SGP_gamma_response</a>(     &amp;n_tmp,
<a name="l00478"></a>00478                                                         &amp;d_total_Gy,
<a name="l00479"></a>00479                                                         gamma_model,
<a name="l00480"></a>00480                                                         gamma_parameters,
<a name="l00481"></a>00481                                                         &amp;S_gamma);
<a name="l00482"></a>00482 
<a name="l00483"></a>00483                 <span class="keywordtype">float</span> efficiency        = 0.0f;
<a name="l00484"></a>00484                 <span class="keywordflow">if</span>(S_gamma &gt; 0){
<a name="l00485"></a>00485                         efficiency = S_HCP / S_gamma;
<a name="l00486"></a>00486                 }
<a name="l00487"></a>00487 
<a name="l00488"></a>00488                 <span class="comment">// write graph (first run)</span>
<a name="l00489"></a>00489                 <span class="keywordtype">bool</span> write_graph = <span class="keyword">true</span>;
<a name="l00490"></a>00490                         <span class="keywordflow">if</span>(write_graph &amp; m == 0){
<a name="l00491"></a>00491                                 FILE*           graph_file;
<a name="l00492"></a>00492                                 graph_file              =       fopen(<span class="stringliteral">"GridGraph.csv"</span>,<span class="stringliteral">"w"</span>);
<a name="l00493"></a>00493                                 <span class="keywordflow">if</span> (graph_file == NULL) <span class="keywordflow">return</span>;         <span class="comment">// File error</span>
<a name="l00494"></a>00494 
<a name="l00495"></a>00495                                 fprintf(graph_file, <span class="stringliteral">"x.m; y.m; d.Gy; S\n"</span>);
<a name="l00496"></a>00496 
<a name="l00497"></a>00497                                 <span class="keywordflow">for</span> (j = 0; j &lt; *nX; j++){
<a name="l00498"></a>00498                                         <span class="keywordflow">for</span> (i = 0; i &lt; *nX; i++){
<a name="l00499"></a>00499                                                 fprintf(graph_file, <span class="stringliteral">"%e; %e; %e; %e\n"</span>, max_r_max_m + ((<span class="keywordtype">float</span>)i + 0.5f)*(*grid_size_m),
<a name="l00500"></a>00500                                                                                                                                 max_r_max_m + ((<span class="keywordtype">float</span>)j + 0.5f)*(*grid_size_m),
<a name="l00501"></a>00501                                                                                                                                 grid_d_Gy[j * (*nX) + i],
<a name="l00502"></a>00502                                                                                                                                 grid_S[j * (*nX) + i]);
<a name="l00503"></a>00503                                         }
<a name="l00504"></a>00504                                 }
<a name="l00505"></a>00505                         }
<a name="l00506"></a>00506 
<a name="l00507"></a>00507                 run_results[0]          = efficiency;
<a name="l00508"></a>00508                 run_results[1]          = d_total_Gy;
<a name="l00509"></a>00509                 run_results[2]          = S_HCP;
<a name="l00510"></a>00510                 run_results[3]          = S_gamma;
<a name="l00511"></a>00511                 run_results[4]          = n_particles;
<a name="l00512"></a>00512 
<a name="l00513"></a>00513                 <span class="comment">// copy to results</span>
<a name="l00514"></a>00514                 results[0]                      += run_results[0];
<a name="l00515"></a>00515                 results[1]                      += run_results[1];
<a name="l00516"></a>00516                 results[2]                      += run_results[2];
<a name="l00517"></a>00517                 results[3]                      += run_results[3];
<a name="l00518"></a>00518                 results[4]                      += run_results[4];
<a name="l00519"></a>00519 
<a name="l00520"></a>00520                 results[5]                      += run_results[0]*run_results[0];
<a name="l00521"></a>00521                 results[6]                      += run_results[1]*run_results[1];
<a name="l00522"></a>00522                 results[7]                      += run_results[2]*run_results[2];
<a name="l00523"></a>00523                 results[8]                      += run_results[3]*run_results[3];
<a name="l00524"></a>00524                 results[9]                      += n_particles * n_particles;
<a name="l00525"></a>00525 
<a name="l00526"></a>00526                 <span class="keywordflow">if</span> (*N_runs &lt;= 20){
<a name="l00527"></a>00527                         fprintf(output_file, <span class="stringliteral">"\n\nRun %d results\n"</span>, m + 1);
<a name="l00528"></a>00528                         fprintf(output_file, <span class="stringliteral">"efficiency                = %e\n"</span>, run_results[0]);
<a name="l00529"></a>00529                         fprintf(output_file, <span class="stringliteral">"d.check.Gy                = %e\n"</span>, run_results[1]);
<a name="l00530"></a>00530                         fprintf(output_file, <span class="stringliteral">"S (HCP)                   = %e\n"</span>, run_results[2]);
<a name="l00531"></a>00531                         fprintf(output_file, <span class="stringliteral">"S (gamma)                 = %e\n"</span>, run_results[3]);
<a name="l00532"></a>00532                         fprintf(output_file, <span class="stringliteral">"no. particles             = %e\n"</span>, run_results[4]);
<a name="l00533"></a>00533                 }
<a name="l00534"></a>00534 
<a name="l00535"></a>00535                 free(x_pos);
<a name="l00536"></a>00536                 free(y_pos);
<a name="l00537"></a>00537                 free(particle_index);
<a name="l00538"></a>00538                 free(r_max_m);
<a name="l00539"></a>00539         }<span class="comment">// end run loop</span>
<a name="l00540"></a>00540 
<a name="l00541"></a>00541         results[0]      /= *N_runs;
<a name="l00542"></a>00542         results[1]      /= *N_runs;
<a name="l00543"></a>00543         results[2]      /= *N_runs;
<a name="l00544"></a>00544         results[3]      /= *N_runs;
<a name="l00545"></a>00545         results[4]      /= *N_runs;
<a name="l00546"></a>00546 
<a name="l00547"></a>00547         results[5]      /= *N_runs;
<a name="l00548"></a>00548         results[6]      /= *N_runs;
<a name="l00549"></a>00549         results[7]      /= *N_runs;
<a name="l00550"></a>00550         results[8]      /= *N_runs;
<a name="l00551"></a>00551         results[9]      /= *N_runs;
<a name="l00552"></a>00552 
<a name="l00553"></a>00553         results[5]      -= results[0]*results[0];
<a name="l00554"></a>00554         results[6]      -= results[1]*results[1];
<a name="l00555"></a>00555         results[7]      -= results[2]*results[2];
<a name="l00556"></a>00556         results[8]      -= results[3]*results[3];
<a name="l00557"></a>00557         results[9]      -= results[4]*results[4];
<a name="l00558"></a>00558 
<a name="l00559"></a>00559         results[5]      = <a class="code" href="../../d4/d28/SGP__Utils_8h.html#985ff4ce447bced94342e89ab3766fdd">FMAX</a>(0, results[5]);
<a name="l00560"></a>00560         results[6]      = <a class="code" href="../../d4/d28/SGP__Utils_8h.html#985ff4ce447bced94342e89ab3766fdd">FMAX</a>(0, results[6]);
<a name="l00561"></a>00561         results[7]      = <a class="code" href="../../d4/d28/SGP__Utils_8h.html#985ff4ce447bced94342e89ab3766fdd">FMAX</a>(0, results[7]);
<a name="l00562"></a>00562         results[8]      = <a class="code" href="../../d4/d28/SGP__Utils_8h.html#985ff4ce447bced94342e89ab3766fdd">FMAX</a>(0, results[8]);
<a name="l00563"></a>00563         results[9]      = <a class="code" href="../../d4/d28/SGP__Utils_8h.html#985ff4ce447bced94342e89ab3766fdd">FMAX</a>(0, results[9]);
<a name="l00564"></a>00564 
<a name="l00565"></a>00565     results[5]  = sqrt(results[5] / (*N_runs - 1));
<a name="l00566"></a>00566         results[6]      = sqrt(results[6] / (*N_runs - 1));
<a name="l00567"></a>00567         results[7]      = sqrt(results[7] / (*N_runs - 1));
<a name="l00568"></a>00568         results[8]      = sqrt(results[8] / (*N_runs - 1));
<a name="l00569"></a>00569         results[9]      = sqrt(results[9] / (*N_runs - 1));
<a name="l00570"></a>00570 
<a name="l00571"></a>00571         fprintf(output_file, <span class="stringliteral">"\n###############################################\nResults\n"</span>);
<a name="l00572"></a>00572         fprintf(output_file, <span class="stringliteral">"efficiency                = %e +/- %e\n"</span>, results[0], results[5]);
<a name="l00573"></a>00573         fprintf(output_file, <span class="stringliteral">"d.check.Gy                = %e +/- %e\n"</span>, results[1], results[6]);
<a name="l00574"></a>00574         fprintf(output_file, <span class="stringliteral">"S (HCP)                   = %e +/- %e\n"</span>, results[2], results[7]);
<a name="l00575"></a>00575         fprintf(output_file, <span class="stringliteral">"S (gamma)                 = %e +/- %e\n"</span>, results[3], results[8]);
<a name="l00576"></a>00576         fprintf(output_file, <span class="stringliteral">"no. particles             = %e +/- %e\n"</span>, results[4], results[9]);
<a name="l00577"></a>00577         fprintf(output_file, <span class="stringliteral">"###############################################\n"</span>);
<a name="l00578"></a>00578         end_t                           = time(NULL);
<a name="l00579"></a>00579         end_tm                          = localtime(&amp;end_t);
<a name="l00580"></a>00580         <span class="keywordtype">float</span> timespan_s        = difftime(end_t, start_t);
<a name="l00581"></a>00581         fprintf(output_file, <span class="stringliteral">"\nEnd time and date: %s\n"</span>, asctime(end_tm));
<a name="l00582"></a>00582         fprintf(output_file, <span class="stringliteral">"\nTime per run [s]:      %4.2e\n"</span>, timespan_s / *N_runs);
<a name="l00583"></a>00583         fprintf(output_file, <span class="stringliteral">"\nTime per pixel [s]:    %4.2e\n"</span>, timespan_s / (*N_runs * n_grid));
<a name="l00584"></a>00584         fprintf(output_file, <span class="stringliteral">"###############################################\n"</span>);
<a name="l00585"></a>00585         fprintf(output_file, <span class="stringliteral">"###############################################\n"</span>);
<a name="l00586"></a>00586 
<a name="l00587"></a>00587         gsl_rng_free(rng1);
<a name="l00588"></a>00588         gsl_rng_free(rng2);
<a name="l00589"></a>00589 
<a name="l00590"></a>00590         free(f1_parameters);
<a name="l00591"></a>00591         free(f_parameters);
<a name="l00592"></a>00592         free(norm_fluence);
<a name="l00593"></a>00593         free(dose_contribution_Gy);
<a name="l00594"></a>00594 
<a name="l00595"></a>00595         free(mean_number_particles);
<a name="l00596"></a>00596         free(act_number_particles);
<a name="l00597"></a>00597 
<a name="l00598"></a>00598         free(grid_d_Gy);
<a name="l00599"></a>00599         free(grid_S);
<a name="l00600"></a>00600 
<a name="l00601"></a>00601         close(output_file);
<a name="l00602"></a>00602 }
<a name="l00603"></a>00603 
<a name="l00604"></a>00604 
<a name="l00605"></a>00605 
<a name="l00606"></a>00606 <span class="comment">/*</span>
<a name="l00607"></a>00607 <span class="comment">BOOL APIENTRY DllMain( HANDLE hModule,</span>
<a name="l00608"></a>00608 <span class="comment">                       DWORD  ul_reason_for_call,</span>
<a name="l00609"></a>00609 <span class="comment">                       LPVOID lpReserved</span>
<a name="l00610"></a>00610 <span class="comment">                                         )</span>
<a name="l00611"></a>00611 <span class="comment">{</span>
<a name="l00612"></a>00612 <span class="comment">    return TRUE;</span>
<a name="l00613"></a>00613 <span class="comment">}</span>
<a name="l00614"></a>00614 <span class="comment">*/</span>
<a name="l00615"></a>00615 
<a name="l00616"></a><a class="code" href="../../d1/dd5/SGParticle_8h.html#75c3e83188b57266eb149e6002ee09aa">00616</a> <span class="keywordtype">void</span> <a class="code" href="../../d4/d2a/SGParticle_8c.html#75c3e83188b57266eb149e6002ee09aa">SGP_efficiency_Katz</a>(       <span class="keywordtype">long</span>*   n,
<a name="l00617"></a>00617                                                         <span class="keywordtype">float</span>*  E_MeV_u,
<a name="l00618"></a>00618                                                         <span class="keywordtype">long</span>*   particle_no,
<a name="l00619"></a>00619                                                         <span class="keywordtype">float</span>*  fluence_cm2,
<a name="l00620"></a>00620                                                         <span class="keywordtype">long</span>*   <a class="code" href="../../d3/de7/SGP__Constants_8h.html#25222ab39d868c8c3763ddac1b75df11">material_no</a>,
<a name="l00621"></a>00621                                                         <span class="keywordtype">long</span>*   RDD_model,
<a name="l00622"></a>00622                                                         <span class="keywordtype">float</span>*  RDD_parameters,
<a name="l00623"></a>00623                                                         <span class="keywordtype">long</span>*   ER_model,
<a name="l00624"></a>00624                                                         <span class="keywordtype">float</span>*  ER_parameters,
<a name="l00625"></a>00625                                                         <span class="keywordtype">long</span>*   gamma_model,
<a name="l00626"></a>00626                                                         <span class="keywordtype">float</span>*  gamma_parameters,
<a name="l00627"></a>00627                                                         <span class="keywordtype">float</span>*  results)
<a name="l00628"></a>00628 {
<a name="l00629"></a>00629         FILE*           output_file;
<a name="l00630"></a>00630         <span class="keyword">struct </span>tm       *start_tm, *end_tm;
<a name="l00631"></a>00631         time_t          start_t, end_t;
<a name="l00632"></a>00632         start_t         = time(NULL);
<a name="l00633"></a>00633 
<a name="l00634"></a>00634         output_file             =       fopen(<span class="stringliteral">"KatseMitGlatse.log"</span>,<span class="stringliteral">"w"</span>);
<a name="l00635"></a>00635         <span class="keywordflow">if</span> (output_file == NULL) <span class="keywordflow">return</span>;                                                                                        <span class="comment">// File error</span>
<a name="l00636"></a>00636 
<a name="l00637"></a>00637         fprintf(output_file, <span class="stringliteral">"##############################################################\n"</span>);
<a name="l00638"></a>00638         fprintf(output_file, <span class="stringliteral">"##############################################################\n"</span>);
<a name="l00639"></a>00639         fprintf(output_file, <span class="stringliteral">"This is SGP efficiency Katz, version(2009/07/13).\n"</span>);
<a name="l00640"></a>00640         fprintf(output_file, <span class="stringliteral">"##############################################################\n"</span>);
<a name="l00641"></a>00641         fprintf(output_file, <span class="stringliteral">"\n\n\n"</span>);
<a name="l00642"></a>00642         start_tm                = localtime(&amp;start_t);
<a name="l00643"></a>00643         fprintf(output_file, <span class="stringliteral">"Start time and date: %s\n"</span>, asctime(start_tm));
<a name="l00644"></a>00644 
<a name="l00645"></a>00645         <span class="keywordflow">if</span> (*gamma_model != 1){
<a name="l00646"></a>00646                 fprintf(output_file, <span class="stringliteral">"##############################################################\n"</span>);
<a name="l00647"></a>00647                 fprintf(output_file, <span class="stringliteral">"Sorry, no Katz with other than the general hit-target model\n"</span>);
<a name="l00648"></a>00648                 fprintf(output_file, <span class="stringliteral">"Please choose gamma_model = 1. Exiting now...\n"</span>);
<a name="l00649"></a>00649                 fprintf(output_file, <span class="stringliteral">"##############################################################\n"</span>);
<a name="l00650"></a>00650                 <span class="keywordflow">return</span>;
<a name="l00651"></a>00651         }
<a name="l00652"></a>00652 
<a name="l00653"></a>00653         <span class="keywordtype">long</span>    i;
<a name="l00654"></a>00654         <span class="comment">// Browse gamma parameters and pick one-hit components</span>
<a name="l00655"></a>00655         <span class="keywordtype">long</span>    n_components            = 0;
<a name="l00656"></a>00656         <span class="keywordtype">long</span>    n_gamma_parameters      = 0;
<a name="l00657"></a>00657         <span class="keywordflow">while</span>   (gamma_parameters[n_gamma_parameters] != 0){
<a name="l00658"></a>00658                 n_gamma_parameters      += 4;
<a name="l00659"></a>00659         }
<a name="l00660"></a>00660         n_components                            = n_gamma_parameters / 4;
<a name="l00661"></a>00661         <span class="keywordtype">bool</span>*   bOneHit                         = (<span class="keywordtype">bool</span>*)calloc(n_components, <span class="keyword">sizeof</span>(<span class="keywordtype">bool</span>));
<a name="l00662"></a>00662 
<a name="l00663"></a>00663         <span class="keywordflow">for</span>(i = 0; i &lt; n_components; i++){
<a name="l00664"></a>00664                 <span class="keywordflow">if</span>(bOneHit[i]){
<a name="l00665"></a>00665 <span class="comment"></span>
<a name="l00666"></a>00666 <span class="comment">                        ////////////////////////////////////////////////////////////////////////////////////////////</span>
<a name="l00667"></a>00667 <span class="comment"></span><span class="comment">/*</span>
<a name="l00668"></a>00668 <span class="comment">                    gsl_set_error_handler_off();</span>
<a name="l00669"></a>00669 <span class="comment"></span>
<a name="l00670"></a>00670 <span class="comment">                        double ext_integral_Gy;</span>
<a name="l00671"></a>00671 <span class="comment">                        double error;</span>
<a name="l00672"></a>00672 <span class="comment">                        gsl_integration_workspace *w1 = gsl_integration_workspace_alloc (10000);</span>
<a name="l00673"></a>00673 <span class="comment">                        gsl_function F;</span>
<a name="l00674"></a>00674 <span class="comment">                        F.function = &amp;SGP_RDD_Katz_ext_integrand_Gy;</span>
<a name="l00675"></a>00675 <span class="comment">//                      float params[] = {*r_m,*a0_m,*alpha,*r_min_m,*r_max_m,*Katz_point_coeff_Gy};</span>
<a name="l00676"></a>00676 <span class="comment">                        F.params = params;</span>
<a name="l00677"></a>00677 <span class="comment">//                      int status = gsl_integration_qags (&amp;F, int_lim_m, (*r_m)+(*a0_m), 1e-9, 1e-4, 10000, w1, &amp;ext_integral_Gy, &amp;error);</span>
<a name="l00678"></a>00678 <span class="comment">                        if (status == GSL_EROUND || status == GSL_ESING){</span>
<a name="l00679"></a>00679 <span class="comment">                #ifdef _DEBUG</span>
<a name="l00680"></a>00680 <span class="comment">                                indnt_init();</span>
<a name="l00681"></a>00681 <span class="comment">                                fprintf(debf,"%s r=%g, integration from %g to %g , error no == %d\n",isp,*r_m,int_lim_m,(*r_m)+(*a0_m),status);</span>
<a name="l00682"></a>00682 <span class="comment">                #endif</span>
<a name="l00683"></a>00683 <span class="comment">                                ext_integral_Gy = -1.0f;</span>
<a name="l00684"></a>00684 <span class="comment">                        }</span>
<a name="l00685"></a>00685 <span class="comment">                        gsl_integration_workspace_free (w1);</span>
<a name="l00686"></a>00686 <span class="comment">*/</span>
<a name="l00687"></a>00687 <span class="comment"></span>
<a name="l00688"></a>00688 <span class="comment">                        ////////////////////////////////////////////////////////////////////////////////////////////</span>
<a name="l00689"></a>00689 <span class="comment"></span>                }
<a name="l00690"></a>00690         }
<a name="l00691"></a>00691 }
<a name="l00692"></a>00692 
</pre></div></div>
<hr size="1"><address style="text-align: right;"><small>Generated on Thu Jul 30 15:49:26 2009 for libSGP by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border="0"></a> 1.5.6 </small></address>
</body>
</html>
